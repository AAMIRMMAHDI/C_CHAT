<!DOCTYPE html>
<html lang="fa" dir="rtl" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>شرکت هوش مصنوعی | چت بات هوشمند</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn.css" rel="stylesheet" />
  <style>
    :root {
      --primary-color: #3b82f6;
      --secondary-color: #1e40af;
      --light-color: #f9fafb;
      --dark-color: #1f2937;
      --success-color: #22c55e;
      --user-message-bg: #3b82f6;
      --ai-message-bg: #ffffff;
      --message-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --border-radius: 12px;
    }

    body {
      font-family: 'Vazirmatn', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: #f1f5f9;
      line-height: 1.7;
      overflow-x: hidden;
    }

    body[data-bs-theme="dark"] {
      --ai-message-bg: #374151;
      --light-color: #1f2937;
      --message-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .chat-container {
      height: 100vh;
      overflow: hidden;
      display: flex;
    }

    .sidebar {
      background-color: var(--bs-body-bg);
      border-left: 1px solid var(--bs-border-color);
      width: 300px;
      transition: transform 0.3s ease;
      overflow-y: auto;
    }

    .sidebar.show {
      transform: translateX(0);
    }

    @media (max-width: 992px) {
      .sidebar {
        position: fixed;
        top: 0;
        right: -300px;
        width: 300px;
        height: 100%;
        z-index: 1050;
        transform: translateX(0);
      }
      .sidebar.show {
        transform: translateX(-300px);
      }
      .main-content {
        margin-right: 0 !important;
      }
    }

    .chat-area {
      height: calc(100vh - 120px);
      overflow-y: auto;
      background-color: var(--light-color);
      padding: 1.5rem;
      scroll-behavior: smooth;
    }

    .message-input {
      border-radius: var(--border-radius);
      resize: none;
      min-height: 48px;
      max-height: 140px;
      padding: 12px 16px;
      transition: all 0.2s ease;
    }

    .message {
      max-width: 80%;
      margin-bottom: 1.2rem;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .user-message {
      background-color: var(--user-message-bg);
      color: white;
      border-radius: var(--border-radius) var(--border-radius) 0 var(--border-radius);
      padding: 14px 18px;
      margin-left: auto;
      box-shadow: var(--message-shadow);
    }

    .ai-message {
      background-color: var(--ai-message-bg);
      border: 1px solid var(--bs-border-color);
      border-radius: var(--border-radius) var(--border-radius) var(--border-radius) 0;
      padding: 14px 18px;
      margin-right: auto;
      box-shadow: var(--message-shadow);
    }

    .message-content {
      font-size: 0.95rem;
      line-height: 1.8;
    }

    .message-content pre {
      background-color: rgba(0, 0, 0, 0.05);
      padding: 12px;
      border-radius: 8px;
      font-family: 'Vazirmatn', monospace;
      font-size: 0.9rem;
      overflow-x: auto;
    }

    .message-content code {
      background-color: rgba(0, 0, 0, 0.05);
      padding: 3px 6px;
      border-radius: 4px;
      font-family: 'Vazirmatn', monospace;
    }

    body[data-bs-theme="dark"] .message-content pre,
    body[data-bs-theme="dark"] .message-content code {
      background-color: rgba(255, 255, 255, 0.08);
    }

    .chat-item:hover, .file-item:hover {
      background-color: rgba(59, 130, 246, 0.1);
      cursor: pointer;
    }

    .chat-item.active {
      background-color: rgba(59, 130, 246, 0.15);
      border-left: 4px solid var(--primary-color);
    }

    .file-item.active {
      border-left: 4px solid var(--success-color);
    }

    .timestamp {
      font-size: 0.8rem;
      color: var(--bs-secondary-color);
      margin-top: 6px;
    }

    .theme-toggle {
      transition: all 0.3s ease;
      font-size: 1.3rem;
    }

    .file-icon {
      width: 28px;
      height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: 10px;
      color: var(--primary-color);
    }

    .typing-indicator {
      display: none;
      align-items: center;
    }

    .typing-dot {
      width: 10px;
      height: 10px;
      background-color: var(--bs-secondary-color);
      border-radius: 50%;
      margin: 0 3px;
      animation: typingAnimation 1.2s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingAnimation {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-6px); }
    }

    .welcome-message {
      max-width: 700px;
      margin: 2rem auto;
      text-align: center;
      padding: 2.5rem;
      background: var(--ai-message-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--message-shadow);
    }

    .empty-state {
      text-align: center;
      padding: 2.5rem;
      color: var(--bs-secondary-color);
    }

    .search-input {
      border-radius: var(--border-radius);
      padding: 10px;
      font-size: 0.9rem;
    }

    .file-drop-zone {
      border: 2px dashed var(--bs-border-color);
      border-radius: var(--border-radius);
      padding: 1rem;
      text-align: center;
      transition: all 0.2s ease;
    }

    .file-drop-zone.dragover {
      background-color: rgba(59, 130, 246, 0.1);
      border-color: var(--primary-color);
    }
    #user-input {
    border-radius: 20px;
    }
    
    #chat-list .list-group-item {
      border-radius: 12px;
      margin-bottom: 8px; /* فاصله بین آیتم‌ها */
      border: 1px solid #ddd; /* خط دور برای بهتر دیده شدن */
      padding: 10px; /* اگر نیاز به فاصله داخلی داری */
    }


  </style>
</head>
<body>
  <div class="chat-container">
    <!-- Sidebar -->
    <div class="sidebar d-flex flex-column">
      <div class="p-3 border-bottom">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0 fw-bold text-primary">
            <i class="bi bi-robot me-2"></i> چت بات هوشمند
          </h5>
          <button class="btn btn-outline-primary d-lg-none" id="close-sidebar">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>
      <!-- Search -->
      <div class="p-3">
        <input type="text" id="chat-search" class="form-control search-input" placeholder="جستجوی مکالمات..." />
      </div>
      <!-- Chats List -->
      <div class="p-3 border-bottom">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="mb-0 fw-bold">مکالمات</h6>
          <button id="new-chat-btn" class="btn btn-sm btn-primary">
            <i class="bi bi-plus-lg me-1"></i> جدید
          </button>
        </div>
        <div class="list-group list-group-flush" id="chat-list"></div>
      </div>
      <!-- Files List -->
      <div class="p-3 flex-grow-1">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="mb-0 fw-bold">فایل‌ها</h6>
          <label for="file-upload" class="btn btn-sm btn-success">
            <i class="bi bi-upload me-1"></i>
          </label>
          <input type="file" id="file-upload" class="d-none" />
        </div>
        <div class="file-drop-zone mb-3" id="file-drop-zone">
          فایل‌ها را اینجا بکشید و رها کنید
        </div>
        <div class="list-group list-group-flush" id="file-list"></div>
      </div>
      <!-- User Profile -->
      <div class="p-3 border-top bg-light">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <div class="fw-bold">کاربر سیستم</div>
            <small class="text-muted">مدیریت چت بات</small>
          </div>
          <div class="theme-toggle" id="theme-toggle">
            <i class="bi bi-moon-fill"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content flex-grow-1 d-flex flex-column">
      <!-- Header -->
      <header class="bg-white p-3 border-bottom d-flex align-items-center">
        <button class="btn btn-outline-secondary d-lg-none me-2" id="toggle-sidebar">
          <i class="bi bi-list"></i>
        </button>
        <h5 class="mb-0 fw-bold flex-grow-1 text-center" id="current-chat-title">مکالمه جدید</h5>
        <div class="dropdown">
          <button class="btn btn-outline-secondary" data-bs-toggle="dropdown">
            <i class="bi bi-three-dots-vertical"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" id="rename-chat"><i class="bi bi-pencil me-2"></i>تغییر نام</a></li>
            <li><a class="dropdown-item" href="#" id="delete-chat"><i class="bi bi-trash me-2"></i>حذف مکالمه</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" id="export-chat"><i class="bi bi-download me-2"></i>خروجی مکالمه</a></li>
          </ul>
        </div>
      </header>
      <!-- Chat Area -->
      <div class="flex-grow-1 chat-area" id="messages">
        <div class="welcome-message">
          <div class="icon">
            <i class="bi bi-robot"></i>
          </div>
          <h4>به چت بات هوشمند خوش آمدید</h4>
          <p class="text-muted">برای شروع، پیام خود را در کادر زیر وارد کنید</p>
        </div>
      </div>
      <!-- Input Area -->
      <div class="p-3 bg-white border-top">
        <div class="input-group">
          <textarea id="user-input" class="form-control message-input" rows="1" placeholder="پیام خود را بنویسید..."></textarea>
          <button id="send-btn" class="btn btn-primary rounded-circle ms-2" style="width: 45px; height: 45px;">
            <i class="bi bi-send-fill"></i>
          </button>
        </div>
        <div class="d-flex justify-content-between mt-2">
          <small class="text-muted typing-indicator" id="typing-indicator">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="me-2">در حال تایپ...</span>
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- File Modal -->
  <div class="modal fade" id="fileModal" tabindex="-1" aria-labelledby="fileModalLabel">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="fileModalLabel">محتویات فایل</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <pre class="m-0 p-3" style="white-space: pre-wrap; font-family: 'Vazirmatn', monospace; line-height: 1.8;"></pre>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
          <button type="button" class="btn btn-primary" id="download-file">
            <i class="bi bi-download me-1"></i> دانلود
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">تایید عملیات</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="confirmModalBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
          <button type="button" class="btn btn-danger" id="confirmAction">تایید</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    let currentChatId = null;
    let currentFileId = null;
    let isTyping = false;
    let chatHistory = [];

    // Initialize tooltips
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

    // Toggle sidebar
    document.getElementById('toggle-sidebar').addEventListener('click', () => {
      document.querySelector('.sidebar').classList.toggle('show');
    });

    document.getElementById('close-sidebar').addEventListener('click', () => {
      document.querySelector('.sidebar').classList.remove('show');
    });

    // Theme toggle
    document.getElementById('theme-toggle').addEventListener('click', () => {
      const htmlEl = document.documentElement;
      const isDark = htmlEl.getAttribute('data-bs-theme') === 'dark';
      htmlEl.setAttribute('data-bs-theme', isDark ? 'light' : 'dark');
      document.getElementById('theme-toggle').innerHTML = isDark ? '<i class="bi bi-moon-fill"></i>' : '<i class="bi bi-sun-fill"></i>';
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
    });

    // Restore theme preference
    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.setAttribute('data-bs-theme', 'dark');
      document.getElementById('theme-toggle').innerHTML = '<i class="bi bi-sun-fill"></i>';
    }

    // Auto-resize textarea
    const userInput = document.getElementById('user-input');
    userInput.addEventListener('input', function () {
      this.style.height = 'auto';
      this.style.height = `${Math.min(this.scrollHeight, 140)}px`;
    });

    // Debounce function
    const debounce = (func, wait) => {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    };

    // Search chats
    document.getElementById('chat-search').addEventListener('input', debounce(e => {
      const searchTerm = e.target.value.trim().toLowerCase();
      document.querySelectorAll('.chat-item').forEach(item => {
        const chatName = item.querySelector('.fw-bold').textContent.toLowerCase();
        item.style.display = chatName.includes(searchTerm) ? '' : 'none';
      });
    }, 300));

    // Load chats
    async function loadChats() {
      try {
        const res = await axios.get('/api/chats');
        const chats = res.data;
        const chatList = document.getElementById('chat-list');
        chatList.innerHTML = chats.length === 0 ? `
          <div class="empty-state">
            <div class="icon"><i class="bi bi-chat-square-text"></i></div>
            <p class="mt-2 mb-0">مکالمه‌ای یافت نشد</p>
          </div>
        ` : '';

        chats.forEach(chat => {
          const chatItem = document.createElement('a');
          chatItem.href = '#';
          chatItem.className = `list-group-item list-group-item-action chat-item py-2 ${chat.id === currentChatId ? 'active' : ''}`;
          chatItem.dataset.id = chat.id;
          chatItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
              <div class="fw-bold text-truncate" style="max-width: 200px;">${escapeHtml(chat.name)}</div>
              <small class="timestamp">${new Date(chat.created_at).toLocaleString('fa-IR')}</small>
            </div>
          `;
          chatItem.addEventListener('click', e => {
            e.preventDefault();
            if (chat.id !== currentChatId) {
              currentChatId = chat.id;
              updateActiveChat();
              loadMessages();
              loadFiles();
              document.querySelector('.sidebar').classList.remove('show');
            }
          });
          chatList.appendChild(chatItem);
        });

        if (!currentChatId && chats.length > 0) {
          currentChatId = chats[0].id;
          updateActiveChat();
          loadMessages();
          loadFiles();
        }
      } catch (err) {
        console.error('Error loading chats:', err);
        showError('خطا در بارگذاری مکالمات');
      }
    }

    // Update active chat
    function updateActiveChat() {
      document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
      const activeChat = document.querySelector(`.chat-item[data-id='${currentChatId}']`);
      if (activeChat) {
        activeChat.classList.add('active');
        document.getElementById('current-chat-title').textContent = activeChat.querySelector('.fw-bold').textContent;
      }
    }

    // Load messages
    async function loadMessages() {
      if (!currentChatId) return;
      try {
        const res = await axios.get(`/api/messages/${currentChatId}`);
        chatHistory = res.data;
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = chatHistory.length === 0 ? `
          <div class="welcome-message">
            <div class="icon"><i class="bi bi-chat-left-text"></i></div>
            <h4>مکالمه جدید</h4>
            <p class="text-muted">پیام خود را در کادر زیر بنویسید</p>
          </div>
        ` : '';

        chatHistory.forEach(msg => addMessageToChat(msg.role, msg.content, msg.timestamp));
        scrollToBottom();
      } catch (err) {
        console.error('Error loading messages:', err);
        showError('خطا در بارگذاری پیام‌ها');
      }
    }

    // Add message to chat
    function addMessageToChat(role, content, timestamp) {
      const messagesDiv = document.getElementById('messages');
      if (messagesDiv.querySelector('.welcome-message')) messagesDiv.innerHTML = '';

      const messageDiv = document.createElement('div');
      messageDiv.className = `message d-flex mb-3 ${role === 'user' ? 'justify-content-end' : 'justify-content-start'}`;
      messageDiv.innerHTML = `
        <div class="${role === 'user' ? 'user-message' : 'ai-message'}">
          <div class="message-content">${marked.parse(escapeHtml(content))}</div>
          <div class="timestamp text-end">${formatTime(timestamp || new Date())}</div>
        </div>
      `;
      messagesDiv.appendChild(messageDiv);
      setTimeout(scrollToBottom, 100);
    }

    // Load files
    async function loadFiles() {
      if (!currentChatId) return;
      try {
        const res = await axios.get(`/api/files/${currentChatId}`);
        const files = res.data;
        const fileList = document.getElementById('file-list');
        fileList.innerHTML = files.length === 0 ? `
          <div class="empty-state">
            <div class="icon"><i class="bi bi-folder"></i></div>
            <p class="mt-2 mb-0">فایلی یافت نشد</p>
          </div>
        ` : '';

        files.forEach(file => {
          const fileItem = document.createElement('a');
          fileItem.href = '#';
          fileItem.className = 'list-group-item list-group-item-action file-item py-2';
          fileItem.dataset.id = file.id;
          fileItem.innerHTML = `
            <div class="d-flex align-items-center">
              <div class="file-icon">${getFileIcon(file.filename)}</div>
              <div class="flex-grow-1">
                <div class="fw-bold text-truncate" style="max-width: 200px;">${escapeHtml(file.filename)}</div>
                <small class="timestamp">${new Date(file.uploaded_at).toLocaleString('fa-IR')}</small>
              </div>
            </div>
          `;
          fileItem.addEventListener('click', e => {
            e.preventDefault();
            currentFileId = file.id;
            showFileContent(file.id, file.filename);
          });
          fileList.appendChild(fileItem);
        });
      } catch (err) {
        console.error('Error loading files:', err);
        showError('خطا در بارگذاری فایل‌ها');
      }
    }

    // Show file content
    async function showFileContent(fileId, filename) {
      try {
        const res = await axios.get(`/api/file_content/${fileId}`);
        const modal = new bootstrap.Modal(document.getElementById('fileModal'));
        document.querySelector('#fileModal .modal-body pre').textContent = res.data.content;
        document.getElementById('fileModalLabel').textContent = filename;
        document.getElementById('download-file').onclick = () => downloadFile(fileId, filename);
        modal.show();
      } catch (err) {
        console.error('Error loading file content:', err);
        showError('خطا در بارگذاری محتوای فایل');
      }
    }

    // Download file
    async function downloadFile(fileId, filename) {
      try {
        const res = await axios.get(`/api/download_file/${fileId}`, { responseType: 'blob' });
        const url = window.URL.createObjectURL(new Blob([res.data]));
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (err) {
        console.error('Error downloading file:', err);
        showError('خطا در دانلود فایل');
      }
    }

    // Send message
    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message || !currentChatId || isTyping) return;

      userInput.value = '';
      userInput.style.height = 'auto';
      isTyping = true;
      document.getElementById('typing-indicator').style.display = 'flex';

      addMessageToChat('user', message);
      try {
        const res = await axios.post(`/api/messages/${currentChatId}`, { message });
        addMessageToChat('assistant', res.data.answer || '[پاسخی دریافت نشد]');
      } catch (err) {
        console.error('Error sending message:', err);
        addMessageToChat('assistant', 'خطا در ارتباط با سرور. لطفاً دوباره تلاش کنید.');
      } finally {
        isTyping = false;
        document.getElementById('typing-indicator').style.display = 'none';
        loadChats();
      }
    }

    // New chat
    document.getElementById('new-chat-btn').addEventListener('click', async () => {
      const chatName = prompt('نام مکالمه جدید:', `مکالمه ${new Date().toLocaleString('fa-IR')}`);
      if (chatName?.trim()) {
        try {
          await axios.post('/api/chats', { name: chatName.trim() });
          loadChats();
        } catch (err) {
          console.error('Error creating chat:', err);
          showError('خطا در ایجاد مکالمه جدید');
        }
      }
    });

    // Rename chat
    document.getElementById('rename-chat').addEventListener('click', async e => {
      e.preventDefault();
      if (!currentChatId) return;
      const activeChat = document.querySelector(`.chat-item[data-id='${currentChatId}']`);
      if (!activeChat) return;

      const currentName = activeChat.querySelector('.fw-bold').textContent;
      const newName = prompt('نام جدید مکالمه:', currentName);
      if (newName?.trim() && newName !== currentName) {
        try {
          await axios.put(`/api/chats/${currentChatId}`, { name: newName.trim() });
          loadChats();
        } catch (err) {
          console.error('Error renaming chat:', err);
          showError('خطا در تغییر نام مکالمه');
        }
      }
    });

    // Delete chat
    document.getElementById('delete-chat').addEventListener('click', e => {
      e.preventDefault();
      if (!currentChatId) return;
      showConfirmation('حذف مکالمه', 'آیا مطمئن هستید که می‌خواهید این مکالمه را حذف کنید؟', async () => {
        try {
          await axios.delete(`/api/chats/${currentChatId}`);
          currentChatId = null;
          document.getElementById('messages').innerHTML = `
            <div class="welcome-message">
              <div class="icon"><i class="bi bi-robot"></i></div>
              <h4>به چت بات هوشمند خوش آمدید</h4>
              <p class="text-muted">برای شروع یک مکالمه جدید، روی دکمه "جدید" کلیک کنید</p>
            </div>
          `;
          document.getElementById('file-list').innerHTML = `
            <div class="empty-state">
              <div class="icon"><i class="bi bi-folder"></i></div>
              <p class="mt-2 mb-0">فایلی یافت نشد</p>
            </div>
          `;
          document.getElementById('current-chat-title').textContent = 'مکالمه جدید';
          loadChats();
        } catch (err) {
          console.error('Error deleting chat:', err);
          showError('خطا در حذف مکالمه');
        }
      });
    });

    // Export chat
    document.getElementById('export-chat').addEventListener('click', e => {
      e.preventDefault();
      if (!currentChatId) return;
      const activeChat = document.querySelector(`.chat-item[data-id='${currentChatId}']`);
      if (!activeChat) return;

      const chatName = activeChat.querySelector('.fw-bold').textContent;
      const content = chatHistory.map(msg => `${msg.role === 'user' ? 'شما' : 'چت بات'}: ${msg.content}\n${formatTime(msg.timestamp)}\n`).join('\n');
      const blob = new Blob([content], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', `${chatName}.txt`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // File upload
    document.getElementById('file-upload').addEventListener('change', async e => {
      if (!currentChatId) {
        showError('لطفاً ابتدا یک مکالمه انتخاب کنید');
        e.target.value = '';
        return;
      }
      const file = e.target.files[0];
      if (!file || file.size > 10 * 1024 * 1024) {
        showError('حجم فایل باید کمتر از ۱۰ مگابایت باشد');
        e.target.value = '';
        return;
      }

      const formData = new FormData();
      formData.append('file', file);
      try {
        await axios.post(`/api/upload_file/${currentChatId}`, formData, {
          headers: { 'Content-Type': 'multipart/form-data' }
        });
        loadFiles();
        e.target.value = '';
      } catch (err) {
        console.error('Error uploading file:', err);
        showError('خطا در آپلود فایل');
        e.target.value = '';
      }
    });

    // Drag and Drop
    const dropZone = document.getElementById('file-drop-zone');
    ['dragover', 'dragenter'].forEach(event => {
      dropZone.addEventListener(event, e => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });
    });
    ['dragleave', 'drop'].forEach(event => {
      dropZone.addEventListener(event, e => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
      });
    });
    dropZone.addEventListener('drop', async e => {
      if (!currentChatId) {
        showError('لطفاً ابتدا یک مکالمه انتخاب کنید');
        return;
      }
      const file = e.dataTransfer.files[0];
      if (!file || file.size > 10 * 1024 * 1024) {
        showError('حجم فایل باید کمتر از ۱۰ مگابایت باشد');
        return;
      }
      const formData = new FormData();
      formData.append('file', file);
      try {
        await axios.post(`/api/upload_file/${currentChatId}`, formData, {
          headers: { 'Content-Type': 'multipart/form-data' }
        });
        loadFiles();
      } catch (err) {
        console.error('Error uploading file:', err);
        showError('خطا در آپلود فایل');
      }
    });

    // Send message on Enter
    userInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    document.getElementById('send-btn').addEventListener('click', sendMessage);

    // Helper functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatTime(dateString) {
      const date = typeof dateString === 'string' ? new Date(dateString) : dateString;
      return `${date.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' })} - ${date.toLocaleDateString('fa-IR')}`;
    }

    function scrollToBottom() {
      const messagesDiv = document.getElementById('messages');
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showError(message) {
      const toast = document.createElement('div');
      toast.className = 'position-fixed bottom-0 end-0 p-3';
      toast.style.zIndex = '1055';
      toast.innerHTML = `
        <div class="toast show" role="alert">
          <div class="toast-header bg-danger text-white">
            <strong class="me-auto">خطا</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
          </div>
          <div class="toast-body">${escapeHtml(message)}</div>
        </div>
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }

    function showConfirmation(title, message, callback) {
      const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
      document.getElementById('confirmModalLabel').textContent = title;
      document.getElementById('confirmModalBody').textContent = message;
      document.getElementById('confirmAction').onclick = () => {
        modal.hide();
        callback();
      };
      modal.show();
    }

    function getFileIcon(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const icons = {
        pdf: 'bi-file-earmark-pdf',
        doc: 'bi-file-earmark-word',
        docx: 'bi-file-earmark-word',
        xls: 'bi-file-earmark-excel',
        xlsx: 'bi-file-earmark-excel',
        ppt: 'bi-file-earmark-ppt',
        pptx: 'bi-file-earmark-ppt',
        txt: 'bi-file-earmark-text',
        csv: 'bi-file-earmark-text',
        json: 'bi-file-earmark-code',
        js: 'bi-file-earmark-code',
        html: 'bi-file-earmark-code',
        css: 'bi-file-earmark-code',
        zip: 'bi-file-earmark-zip',
        rar: 'bi-file-earmark-zip',
        jpg: 'bi-file-earmark-image',
        jpeg: 'bi-file-earmark-image',
        png: 'bi-file-earmark-image',
        gif: 'bi-file-earmark-image',
        mp3: 'bi-file-earmark-music',
        mp4: 'bi-file-earmark-play',
        mov: 'bi-file-earmark-play',
        avi: 'bi-file-earmark-play'
      };
      return `<i class="bi ${icons[ext] || 'bi-file-earmark'}"></i>`;
    }

    // Initialize
    loadChats();
  </script>
</body>
</html>